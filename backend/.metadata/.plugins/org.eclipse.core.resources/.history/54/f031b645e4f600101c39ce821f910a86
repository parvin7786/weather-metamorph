package com.example.weather_backend.cache;


import com.example.weather.model.WeatherResponse;
import org.springframework.stereotype.Component;

import java.time.Instant;
import java.util.LinkedHashMap;
import java.util.Map;

@Component
public class WeatherCache {

    private static final int MAX_ENTRIES = 100;
    private static final long TTL_SECONDS = 600;

    private final Map<String, CacheEntry> cache =
            new LinkedHashMap<>(16, 0.75f, true) {
                @Override
                protected boolean removeEldestEntry(Map.Entry<String, CacheEntry> eldest) {
                    return size() > MAX_ENTRIES;
                }
            };

    public synchronized WeatherResponse get(String city) {
        CacheEntry entry = cache.get(city.toLowerCase());

        if (entry == null || entry.isExpired()) {
            cache.remove(city.toLowerCase());
            return null;
        }
        return entry.data;
    }

    public synchronized void put(String city, WeatherResponse data) {
        cache.put(city.toLowerCase(), new CacheEntry(data));
    }

    private static class CacheEntry {
        WeatherResponse data;
        long createdAt = Instant.now().getEpochSecond();

        boolean isExpired() {
            return Instant.now().getEpochSecond() - createdAt > TTL_SECONDS;
        }
    }
}

